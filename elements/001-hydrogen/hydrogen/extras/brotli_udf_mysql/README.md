# Brotli Decompression UDF for MySQL

This directory contains the MySQL User Defined Function (UDF) for Brotli decompression, used by the Helium migration system to decompress large base64-encoded strings.

## Files

- `brotli_decompress.c` - C implementation of Brotli decompression UDF
- `Makefile` - Build and installation automation
- `README.md` - This file

## Dependencies

- MySQL 5.7+ or MariaDB 10.2+
- libbrotlidec (Brotli decompression library)
- mysql-dev package (for mysql.h headers)
- gcc compiler

### Installing Dependencies

```bash
# Ubuntu/Debian
sudo apt-get install libmysqlclient-dev libbrotli-dev

# RHEL/CentOS
sudo yum install mysql-devel brotli-devel
```

## Building

```bash
# Build the shared object
make

# Install to MySQL plugin directory
sudo make install
```

## Registration

Register the UDF in MySQL:

```bash
# Register the function
make register

# Or manually in MySQL:
mysql -e "CREATE FUNCTION BROTLI_DECOMPRESS RETURNS STRING SONAME 'brotli_decompress.so';"
```

## Testing

```bash
# Basic test
make test

# Manual testing
mysql -e "SELECT 'UDF installed' AS status;"
```

## Usage in Migrations

The UDF is automatically used by migration 1000 when processing migrations with compressed strings larger than 1KB:

```sql
-- Example usage (generated automatically)
INSERT INTO queries (code) VALUES (
    BROTLI_DECOMPRESS(cast(from_base64('base64_encoded_compressed_data') as char character set utf8mb4))
);
```

## Detailed Migration System Integration

The Brotli decompression UDF integrates with MySQL's native base64 functions for optimal performance.

### Automatic Function Creation

Migration 1000 (`acuranzo_1000.lua`) handles the UDF lifecycle:

1. **Cleanup**: Drops any existing `BROTLI_DECOMPRESS` function
2. **Creation**: Creates the new UDF using the shared library

```sql
-- Generated by migration 1000
DROP FUNCTION IF EXISTS BROTLI_DECOMPRESS;

CREATE FUNCTION BROTLI_DECOMPRESS RETURNS STRING SONAME 'brotli_decompress.so';
```

### Compression Pipeline

The migration system uses this processing chain for large strings:

1. **Detection**: Identifies strings > 1KB in `[=[multiline blocks]=]`
2. **Compression**: Brotli compression with quality level 11
3. **Encoding**: Base64 encoding using standard base64
4. **Storage**: MySQL's `FROM_BASE64()` handles decoding, UDF handles decompression

### Generated SQL Examples

#### Compressed Migration Code

```sql
INSERT INTO queries (code) VALUES (
    BROTLI_DECOMPRESS(CAST(FROM_BASE64('H4sIAAAAAAAA/0XOwQ2AIBAE0F8h...') AS CHAR CHARACTER SET utf8mb4))
);
```

#### Full Pipeline Example

The migration system generates this complete pattern:

```sql
-- Automatic generation from multiline SQL blocks
BROTLI_DECOMPRESS(CAST(FROM_BASE64('encoded_compressed_data') AS CHAR CHARACTER SET utf8mb4))
```

### Migration Author Experience

Authors write standard SQL with multiline markers:

```lua
-- In migration file
sql=[[
    [=[
        CREATE TABLE users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            email VARCHAR(255) NOT NULL,
            -- ... lots of DDL
        );
    ]=]
]]
```

The system transparently converts this to compressed storage.

## Function Signature

```sql
CREATE FUNCTION BROTLI_DECOMPRESS(compressed_data BLOB)
RETURNS STRING
SONAME 'brotli_decompress.so';
```

## Troubleshooting

### Error: Can't open shared library 'brotli_decompress.so'

Solution:

```bash
# Check plugin directory
mysql -e "SHOW VARIABLES LIKE 'plugin_dir';"

# Manually install
sudo cp brotli_decompress.so /path/to/plugin_dir/
sudo chmod 755 /path/to/plugin_dir/brotli_decompress.so
```

### Error: Cannot load library libbrotlidec.so

Solution:

```bash
# Install Brotli development package
sudo apt-get install libbrotli-dev

# Update library cache
sudo ldconfig
```

### Error: Function already exists

Solution:

```bash
# Drop and recreate
mysql -e "DROP FUNCTION IF EXISTS BROTLI_DECOMPRESS;"
make register
```

## Performance

- Simple wrapper around libbrotlidec
- < 1ms decompression for most strings
- Minimal memory overhead
- Thread-safe

## Version History

- 1.0.0 (2025-11-27) - Initial creation for Brotli decompression support