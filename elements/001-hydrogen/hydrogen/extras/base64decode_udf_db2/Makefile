# Makefile for TEST.BASE64DECODE (chunked C UDF + SQL wrapper)
# Usage:
#   export DB2DIR=/opt/ibm/db2/V11.5        # adjust for your install
#   make                                    # builds .so
#   make install                            # copies .so to sqllib/function
#   make register DB=HYDROTST SCHEMA=TEST   # creates functions + smoke test
#   make test DB=HYDROTST                   # run tests again
#   make clean

DB2DIR ?= /opt/ibm/db2/V12.1
SCHEMA  ?= TEST
DB      ?= HYDROTST

CC      := gcc
CFLAGS  := -fpic -O2 -I"$(DB2DIR)/include" -D_REENTRANT
LDFLAGS := -shared -Wl,-rpath,$(DB2DIR)/lib64
LIBS    := -L$(DB2DIR)/lib64 -ldb2 -lpthread
SO_DIR  := /home/db2inst1/sqllib/function
SO_FILE := base64_chunk_udf.so
SRC     := base64_chunk_udf.c

.PHONY: all install register test clean

all: $(SO_FILE)

$(SO_FILE): $(SRC)
	$(CC) $(CFLAGS) -c $(SRC)
	$(CC) $(LDFLAGS) -o $@ base64_chunk_udf.o $(LIBS)
	rm -f base64_chunk_udf.o

install: $(SO_FILE)
	sudo mkdir -p "$(SO_DIR)"
	sudo cp -f "$(SO_FILE)" "$(SO_DIR)/"
	sudo chmod 755 "$(SO_DIR)/$(SO_FILE)"

register:
	@echo "Connecting to $(DB) and registering UDFs in schema $(SCHEMA)..."
	@tmpfile=$$(mktemp /tmp/install_base64decode.XXXXXX.clp); \
	  { \
	    echo "CONNECT TO $(DB)@"; \
	    echo "SET CURRENT SCHEMA $(SCHEMA)@"; \
	    sed -e "s/\$${SCHEMA}/$(SCHEMA)/g" install_base64decode.clp; \
	  } > $$tmpfile; \
	  db2 -td@ -vf $$tmpfile; \
	  rm -f $$tmpfile
	@echo "Done."

test:
	db2 -v "CONNECT TO $(DB)"
	db2 -tv "VALUES CAST($(SCHEMA).BASE64DECODE('SGVsbG8gV29ybGQh') AS VARCHAR(100))"
	db2 -tv "VALUES length($(SCHEMA).BASE64DECODE('SGVsbG8gV29ybGQh'))"
	db2 -tv "VALUES length($(SCHEMA).BASE64DECODE('MTA4MAoxMC1wb2ludAoxMHRoCjExLXBvaW50CjEyLXBvaW50CjE2LXBvaW50CjE4LXBvaW50CjFzdAoyCjIwLXBvaW50CjIsNCw1LXQKMiw0LWQKMkQKMm5kCjMwLTMwCjMtRAozLWQKM0QKM00KM3JkCjQ4LXBvaW50CjQtRAo0R0wKNEgKNHRoCjUtcG9pbnQKNS1UCjV0aAo2LXBvaW50CjZ0aAo3LXBvaW50Cjd0aAo4LXBvaW50Cjh0aAo5LXBvaW50Cjl0aAotYQpBCkEuCmEKYScKYS0KYS4KQS0xCkExCmExCkE0CkE1CkFBCmFhCkEuQS5BLgpBQUEKYWFhCkFBQUEKQUFBQUFBCkFBQUwKQUFBUwpBYWJlcmcKQWFjaGVuCkFBRQpBQUVFCkFBRgpBQUcKYWFoCmFhaGVkCmFhaGluZwphYWhzCkFBSUkKYWFsCkFhbGJvcmcKQWFsZXN1bmQKYWFsaWkKYWFsaWlzCmFhbHMKQWFsc3QKQWFsdG8KQUFNCmFhbQpBQU1TSQpBYW5kYWhsCkEtYW5kLVIKQWFuaQpBQU8KQUFQCkFBUFNTCkFhcWJpeWUKQWFyCkFhcmEKQWFyYXUKQUFSQwphYXJkdmFyawphYXJkdmFya3MKYWFyZHdvbGYKYWFyZHdvbHZlcwpBYXJlbgpBYXJnYXUKYWFyZ2gKQWFyaHVzCkFhcmlrYQpBYXJvbgphYXJvbgpBYXJvbmljCmFhcm9uaWMKQWFyb25pY2FsCkFhcm9uaXRlCkFhcm9uaXRpYwpBYXJvbidzLWJlYXJkCkFhcm9uc2J1cmcKQWFyb25zb24KQUFSUAphYXJyZ2gKYWFycmdoaApBYXJ1CkFBUwphYXMKQSdhc2lhCmFhc3ZvZ2VsCmFhc3ZvZ2VscwpBQVUKQUFVUApBQVVXCkFBVlNPCkFBWApBLWF4ZXMKQS1heGlzCkEuQi4KQUIKQWIKYWIKYWItCkEuQi5BLgpBQkEKQWJhCmFiYQpBYmFiYQpBYmFiZGVoCkFiYWJ1YQphYmFjCmFiYWNhCmFiYWNhcwphYmFjYXRlCmFiYWNheGkKYWJhY2F5CmFiYWNpCmFiYWNpbmF0ZQphYmFjaW5hdGlvbgphYmFjaXNjaQphYmFjaXNjdXMKYWJhY2lzdAphYmFjawphYmFjbGkKQWJhY28KYWJhY290CmFiYWN0ZXJpYWwKYWJhY3RpbmFsCmFiYWN0aW5hbGx5CmFiYWN0aW9uCmFiYWN0b3IKYWJhY3VsaQphYmFjdWx1cwphYmFjdXMKYWJhY3VzZXMKQWJhZAphYmFkYQpBYmFkYW4KQWJhZGRvbgphYmFkZG9uCmFiYWRlam8KYWJhZGVuZ28KYWJhZGlhCkFiYWRpdGUKYWJhZmYKYWJhZnQKQWJhZ2FlbApBYmFnYWlsCkFiYWd0aGEKQWJhaWxhcmQKYWJhaXNhbmNlCmFiYWlzZWQKYWJhaXNlcgphYmFpc3NlCmFiYWlzc2VkCmFiYWthCkFiYWthbgphYmFrYXMKQWJha3Vtb3YKYWJhbGF0aW9uCmFiYWxpZW5hdGUKYWJhbGllbmF0ZWQKYWJhbGllbmF0aW5nCmFiYWxpZW5hdGlvbgphYmFsb25lCmFiYWxvbmVzCkFiYW1hCmFiYW1wCmFiYW1wZXJlCmFiYW1wZXJlcwphYmFtcHMKQWJhbmEKYWJhbmQKYWJhbmRvbgphYmFuZG9uYWJsZQphYmFuZG9uZWQKYWJhbmRvbmVkbHkKYWJhbmRvbmVlCmFiYW5kb25lcgphYmFuZG9uZXJzCmFiYW5kb25pbmcKYWJhbmRvbm1lbnQKYWJhbmRvbm1lbnRzCmFiYW5kb25zCmFiYW5kdW0KYWJhbmV0CmFiYW5nYQpBYmFuaWMKYWJhbm5pdGlvbgpBYmFudGVzCmFiYXBpY2FsCmFiYXB0aXN0b24KYWJhcHRpc3R1bQpBYmFyYW1ibwpBYmFyYmFyZWEKQWJhcmlzCmFiYXJ0aHJvc2lzCmFiYXJ0aWN1bGFyCmFiYXJ0aWN1bGF0aW9uCkFiYXMKYWJhcwphYmFzZQphYmFzZWQKYWJhc2VkbHkKYWJhc2VkbmVzcwphYmFzZW1lbnQKYWJhc2VtZW50cwphYmFzZXIKYWJhc2VycwphYmFzZXMKQWJhc2dpCmFiYXNoCmFiYXNoZWQKYWJhc2hlZGx5CmFiYXNoZWRuZXNzCmFiYXNoZXMKYWJhc2hpbmcKYWJhc2hsZXNzCmFiYXNobGVzc2x5CmFiYXNobWVudAphYmFzaG1lbnRzCmFiYXNpYQphYmFzaWFzCmFiYXNpYwphYmFzaW5nCmFiYXNpbwphYmFzawphYmFzc2kKQWJhc3NpZWgKQWJhc3NpbgphYmFzdGFyZAphYmFzdGFyZGl6ZQphYmFzdHJhbAphYmF0YWJsZQphYmF0YWdlCkFiYXRlCmFiYXRlCmFiYXRlZAphYmF0ZW1lbnQKYWJhdGVtZW50cwphYmF0ZXIKYWJhdGVycwphYmF0ZXMKYWJhdGljCmFiYXRpbmcKYWJhdGlzCmFiYXRpc2VkCmFiYXRpc2VzCmFiYXRqb3VyCmFiYXRqb3VycwphYmF0b24KYWJhdG9yCmFiYXRvcnMKQUJBVFMKYWJhdHRhZ2UKYWJhdHRpcwphYmF0dGlzZWQKYWJhdHRpc2VzCmFiYXR0b2lyCmFiYXR0b2lycwphYmF0dHUKYWJhdHR1ZQpBYmF0dWEKYWJhdHVyZQphYmF1ZQphYmF2ZQphYmF4aWFsCmFiYXhpbGUKYWJheQphYmF5YWgKYWJhemUKYWJiCkFiYmEKYWJiYQphYmJhY2llcwphYmJhY29tZXMKYWJiYWN5CkFiYmFkaWRlCkFiYmFpCmFiYmFuZG9ubwphYmJhcwphYmJhc2kKQWJiYXNpZAphYmJhc2lkCmFiYmFzc2kKQWJiYXNzaWQKQWJiYXNzaWRlCkFiYmF0ZQphYmJhdGUKYWJiYXRpYWwKYWJiYXRpY2FsCmFiYmF0aWUKYWJiYXllCkFiYmUKYWJiZQphYmJlcwphYmJlc3MKYWJiZXNzZXMKYWJiZXN0CkFiYmV2aWxlYW4KQWJiZXZpbGxlCkFiYmV2aWxsaWFuCmFiYmV2aWxsaWFuCkFiYmV5CmFiYmV5CmFiYmV5cwphYmJleXN0ZWFkCmFiYmV5c3RlZGUKQWJiaQpBYmJpZQphYmJvY2NhdG8KYWJib2dhZGEKQWJib3QKYWJib3QKYWJib3RjaWVzCmFiYm90Y3kKYWJib3RudWxsaXVzCmFiYm90cmljCmFiYm90cwpBYmJvdHNlbgpBYmJvdHNmb3JkCmFiYm90c2hpcAphYmJvdHNoaXBzCkFiYm90c29uCkFiYm90c3VuCkFiYm90dAphYmJvdHQKQWJib3R0c29uCkFiYm90dHN0b3duCkFiYm91ZAphYmJvenpvCkFCQlIKYWJicgphYmJyZXYKYWJicmV2aWF0YWJsZQphYmJyZXZpYXRlCmFiYnJldmlhdGVkCmFiYnJldmlhdGVseQphYmJyZXZpYXRlcwphYmJyZXZpYXRpbmcKYWJicmV2aWF0aW9uCmFiYnJldmlhdGlvbnMKYWJicmV2aWF0b3IKYWJicmV2aWF0b3JzCmFiYnJldmlhdG9yeQphYmJyZXZpYXR1cmUKYWJicm9hY2htZW50CkFiYnkKYWJieQpBYmJ5ZQpBYmJ5dmlsbGUKQUJDCmFiYwphYmNlc3MKYWJjaXNzYQphYmNvdWxvbWIKQUJDcwphYmQKYWJkYWwKYWJkYWxpCmFiZGFyaWEKYWJkYXQKQWJkZWwKQWJkLWVsLUthZGlyCkFiZC1lbC1LcmltCkFiZGVsbGEKQWJkZXJoYWxkZW4KQWJkZXJpYW4KQWJkZXJpdGUKQWJkZXJ1cwphYmRlc3QKQWJkaWFzCmFiZGljYWJsZQphYmRpY2FudAphYmRpY2F0ZQphYmRpY2F0ZWQKYWJkaWNhdGVzCmFiZGljYXRpbmcKYWJkaWNhdGlvbgphYmRpY2F0aW9ucwphYmRpY2F0aXZlCmFiZGljYXRvcgpBYmRpZWwKYWJkaXRpdmUKYWJkaXRvcnkKYWJkb20KYWJkb21lbgphYmRvbWVucwphYmRvbWluYQphYmRvbWluYWwKQWJkb21pbmFsZXMKYWJkb21pbmFsZXMKYWJkb21pbmFsaWEKYWJkb21pbmFsaWFuCmFiZG9taW5hbGx5CmFiZG9taW5hbHMKYWJkb21pbm9hbnRlcmlvcgphYmRvbWlub2NhcmRpYWMKYWJkb21pbm9jZW50ZXNpcwphYmRvbWlub2N5c3RpYwphYmRvbWlub2dlbml0YWwKYWJkb21pbm9oeXN0ZXJlY3RvbXkKYWJkb21pbm9oeXN0ZXJvdG9teQphYmRvbWlub3Bvc3RlcmlvcgphYmRvbWlub3Njb3BlCmFiZG9taW5vc2NvcHkKYWJkb21pbm90aG9yYWNpYwphYmRvbWlub3VzCmFiZG9taW5vLXV0ZXJvdG9teQphYmRvbWlub3ZhZ2luYWwKYWJkb21pbm92ZXNpY2FsCkFiZG9uCkFiZHUKYWJkdWNlCmFiZHVjZWQKYWJkdWNlbnMKYWJkdWNlbnQKYWJkdWNlbnRlcwphYmR1Y2VzCmFiZHVjaW5nCmFiZHVjdAphYmR1Y3RlZAphYmR1Y3RpbmcKYWJkdWN0aW9uCmFiZHVjdGlvbnMKYWJkdWN0b3IKYWJkdWN0b3JlcwphYmR1Y3RvcnMKYWJkdWN0cwpBYmR1bApBYmR1bC1Beml6CkFiZHVsLWJhaGEKQWJkdWxsYQpBYmUKYS1iZQphYmVhbQphYmVhcgphYmVhcmFuY2UKQWJlYmkKYWJlY2VkYWlyZQphYmVjZWRhcmlhCmFiZWNlZGFyaWFuCmFiZWNlZGFyaWFucwphYmVjZWRhcmllcwphYmVjZWRhcml1bQphYmVjZWRhcml1cwphYmVjZWRhcnkKYWJlZAphYmVkZQphYmVkZ2UKQWJlZG5lZ28KYWJlZ2dlCmFiZWlnaApBQkVMCkFiZWwKYWJlbApBYmVsYXJkCmFiZWxlCmFiZWxlcwpBYmVsaWEKQWJlbGlhbgphYmVsaWFuCkFiZWxpY2VhCkFiZWxpdGUKYWJlbGl0ZQpBYmVsbApBYmVsbW9zY2h1cwphYmVsbW9zawphYmVsbW9za3MKYWJlbG11c2sKQWJlbG9uaWFuCkFiZWxzb24KYWJlbHRyZWUK'))"

clean:
	rm -f $(SO_FILE)

