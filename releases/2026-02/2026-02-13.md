# 2026-Feb-13 (Friday)

## (H) Prometheus Metrics Format Fixes

Fixed Prometheus metrics output to conform to Prometheus exposition format requirements:

- **Duplicate HELP/TYPE Lines**: Fixed [`format_prometheus_percentage()`](elements/001-hydrogen/hydrogen/src/status/status_formatters.c:220) to output HELP/TYPE lines once per metric instead of for each data point
- **Label Format**: Changed label format from `{core}` to proper `{core="0"}` format with key=value pairs
- **Metric Prefix**: Added `hydrogen_` prefix to all metrics for proper namespacing (e.g., `cpu_usage_total` â†’ `hydrogen_cpu_usage_total`)
- **Network Metrics**: Fixed duplicate HELP/TYPE output for network interface metrics by grouping data points under single header

Files modified:

- [`elements/001-hydrogen/hydrogen/src/status/status_formatters.c`](elements/001-hydrogen/hydrogen/src/status/status_formatters.c)
- [`elements/001-hydrogen/hydrogen/src/status/status_formatters.h`](elements/001-hydrogen/hydrogen/src/status/status_formatters.h)
- [`elements/001-hydrogen/hydrogen/tests/unity/src/status/status_formatters_test_format_prometheus_percentage.c`](elements/001-hydrogen/hydrogen/tests/unity/src/status/status_formatters_test_format_prometheus_percentage.c)

## (H) Swagger Proxy Support

Fixed Swagger UI mixed-content errors when running behind DOKS load balancer with SSL termination:

- **Protocol Detection**: Updated [`get_server_url()`](elements/001-hydrogen/hydrogen/src/swagger/swagger.c:644) to check `X-Forwarded-Proto` header for HTTPS detection
- **Port Handling**: Added `X-Forwarded-Port` header support; suppresses internal port (7000) when behind proxy, using standard HTTPS port (443) instead
- **URL Generation**: Swagger URLs now correctly use `https://` scheme and omit internal port when served through load balancer

Files modified:

- [`elements/001-hydrogen/hydrogen/src/swagger/swagger.c`](elements/001-hydrogen/hydrogen/src/swagger/swagger.c)
